# 对话系统测试器使用说明

## 📋 功能概述

`ChatSystemTester` 是一个可以在 Unity 编辑器中直接使用的对话系统测试工具，无需运行游戏即可测试所有对话功能。

### ✨ 主要功能

1. ✅ **对话测试** - 在 Inspector 中直接输入消息并查看NPC回复
2. ✅ **思考查看** - 实时查看NPC的内心想法和行为指导
3. ✅ **记忆查看** - 查看短期记忆（总结）和长期记忆（RAG知识库）
4. ✅ **强制记忆转化** - 手动触发记忆提取
5. ✅ **完整状态导出** - 导出所有记忆和对话数据

---

## 🚀 快速开始

### 步骤1: 创建测试对象

1. 在 Unity Hierarchy 中，右键 → `Create Empty`
2. 重命名为 `ChatSystemTester`
3. 添加 `ChatSystemTester` 组件
   - 方法1: 拖拽脚本到 GameObject 上
   - 方法2: Add Component → 搜索 `ChatSystemTester`

### 步骤2: 配置 NPC Profile

1. 创建 NPCProfile（如果还没有）:
   - 在 Project 窗口右键 → `Create` → `ScriptableObject` → `NPCProfile`
   - 配置角色信息（名称、背景、性格等）
   - **重要**: 设置 `npcId`（唯一标识符）

2. 在 Inspector 中:
   - 将创建的 NPCProfile 拖拽到 `NPC Profile` 字段

### 步骤3: 创建 LLMProfile（如果需要）

1. 在 Project 窗口右键 → `Create` → `ScriptableObject` → `LLMProfile`
2. 配置 LLM 参数（模型、温度、Token限制等）
3. 将 LLMProfile 关联到 NPCProfile 中

### 步骤4: 开始测试

1. 在 `输入消息` 框中输入要发送的消息
2. 点击 **📤 发送消息** 按钮
3. 等待回复显示在 `对话历史` 区域

---

## 🎮 界面说明

### 📋 NPC 配置
- **NPC Profile**: 要测试的NPC配置文件

### 💬 对话测试
- **输入消息**: 输入要发送给NPC的消息
- **📤 发送消息**: 发送消息并获取回复
- **🔄 刷新**: 刷新所有显示区域

### 💭 对话历史
- 显示所有对话记录（玩家和NPC）
- **📜 显示完整历史**: 重新加载并显示完整对话历史

### 🧠 当前思考
- **内心想法**: NPC对当前情况的主观感受
- **行为指导**: NPC接下来的行为准则
- **有效期**: 显示思考的使用次数
- **💭 强制重新思考**: 清除当前思考，下次对话时重新思考

### 📚 记忆系统

#### 短期记忆（对话总结）
- 显示由 LLM 生成的对话总结
- 当对话历史超出限制时自动生成

#### 长期记忆（RAG知识库）
- 显示提取的关键记忆事实
- 包含类型、重要度、内容、时间等信息
- **🔥 强制记忆转化**: 手动触发记忆提取（不等待自动触发）

### 📊 统计信息
- **对话次数**: 当前NPC的对话轮数
- **长期记忆数**: 已存储的长期记忆数量
- **状态消息**: 当前操作状态

### 🛠️ 操作
- **📤 导出完整状态**: 将所有数据导出到控制台
- **🗑️ 清除对话**: 仅清除对话历史（保留记忆和思考）
- **💥 清除所有记忆**: 清除所有数据（对话、记忆、思考）

---

## 📖 使用场景

### 场景1: 基础对话测试

```
1. 设置 NPCProfile
2. 输入: "你好！"
3. 点击 "发送消息"
4. 查看对话历史中的回复
```

### 场景2: 测试思考系统

```
1. 进行第一次对话 → 查看 "当前思考" 区域
2. 继续对话5次（或配置的间隔）
3. 观察思考内容是否更新
4. 点击 "强制重新思考" 可以立即触发新思考
```

### 场景3: 测试记忆提取

```
1. 进行几轮包含关键信息的对话
   例如: "我答应帮你找回失物"
2. 点击 "强制记忆转化" 按钮
3. 查看 "长期记忆" 区域是否出现提取的记忆
4. 继续对话，观察NPC是否能记住之前的承诺
```

### 场景4: 测试上下文溢出

```
1. 在 ConversationManager 中设置 MaxHistoryCount = 5
2. 进行10次对话
3. 观察 "短期记忆" 区域是否生成总结
4. 查看 "对话历史" 只保留最近的对话
```

### 场景5: 调试问题

```
1. 进行对话测试
2. 点击 "导出完整状态"
3. 在 Console 窗口查看完整的状态信息
4. 分析对话、记忆、思考的详细内容
```

---

## 🎯 测试检查清单

### ✅ 基础功能
- [ ] NPC能正常回复消息
- [ ] 对话历史正确显示
- [ ] 状态消息正确更新

### ✅ 思考系统
- [ ] 首次对话触发思考
- [ ] 思考内容正确显示（内心想法 + 行为指导）
- [ ] 达到间隔时重新思考
- [ ] 强制重新思考功能正常

### ✅ 记忆系统
- [ ] 对话历史正常记录
- [ ] 上下文溢出时生成短期记忆
- [ ] 强制记忆转化功能正常
- [ ] 长期记忆正确提取和显示
- [ ] 长期记忆能在后续对话中被检索和使用

### ✅ 数据管理
- [ ] 清除对话历史功能正常
- [ ] 清除所有记忆功能正常
- [ ] 统计信息正确显示
- [ ] 导出完整状态功能正常

---

## ⚠️ 注意事项

### 1. **确保单例已初始化**

如果在编辑器中运行测试，确保以下单例已经存在：
- `ChatAgent.Instance`
- `ConversationManager.Instance`
- `ThoughtManager.Instance`
- `MemoryExtractor.Instance`
- `LLMManager.Instance`

**解决方法**: 在场景中添加一个 GameObject 并挂载这些单例脚本，或者确保它们在使用前被初始化。

### 2. **API Key 配置**

确保 `Consts.cs` 中的 API Key 已正确配置：
```csharp
public const string DefaultApiKey = "your-api-key-here";
```

### 3. **网络连接**

测试器需要调用外部 LLM API，确保网络连接正常。

### 4. **异步操作**

发送消息、记忆转化等操作是异步的，需要等待完成。测试器会显示 "正在处理中..." 状态。

### 5. **NPC ID 唯一性**

每个 NPCProfile 的 `npcId` 必须唯一，否则会导致记忆混淆。

---

## 🐛 常见问题

### Q1: 点击"发送消息"没有反应？

**可能原因**:
- NPCProfile 未设置
- 输入消息为空
- 正在处理中（等待上一个请求完成）

**解决方法**: 检查 "状态消息" 显示的错误信息

---

### Q2: 思考内容一直不更新？

**可能原因**:
- 未达到思考间隔（默认5次对话）
- 思考系统被禁用

**解决方法**:
- 查看 `ThoughtManager.ThoughtInterval` 配置
- 检查 `ChatAgent.EnableThoughtSystem` 是否为 true
- 使用 "强制重新思考" 按钮立即触发

---

### Q3: 长期记忆不提取？

**可能原因**:
- 对话内容不包含需要记忆的关键信息
- 上下文未达到溢出触发自动提取

**解决方法**:
- 使用 "强制记忆转化" 手动触发
- 进行包含承诺、关系变化等关键信息的对话

---

### Q4: 导出完整状态看不到内容？

**解决方法**: 打开 Unity Console 窗口（Window → General → Console），导出的内容会显示在那里。

---

## 💡 高级技巧

### 技巧1: 快速测试多个NPC

1. 创建多个测试对象（ChatSystemTester1, ChatSystemTester2...）
2. 每个对象配置不同的 NPCProfile
3. 可以在不同对象间切换测试

### 技巧2: 模拟长期对话

```
1. 禁用思考系统（ChatAgent.EnableThoughtSystem = false）
2. 快速进行多轮对话
3. 重新启用思考系统
4. 观察思考内容的变化
```

### 技巧3: 测试记忆检索

```
1. 添加多条长期记忆（通过多次对话 + 记忆转化）
2. 输入与某条记忆相关的问题
3. 点击 "发送消息"
4. 在对话中观察NPC是否提到了相关记忆
5. 启用 ChatAgent.LogSystemPrompt 查看系统提示词中的记忆
```

### 技巧4: 性能测试

```
1. 设置 MaxHistoryCount = 5
2. 进行20次对话
3. 观察记忆总结和提取的效率
4. 查看 Console 中的处理时间日志
```

---

## 📚 相关文档

- [框架API文档.md](../Chat/框架API文档.md) - 完整的API参考
- [思考系统说明.md](../Chat/NPC/Thought/思考系统说明.md) - 思考系统详解

---

## 🎉 开始测试吧！

现在你可以在 Unity 编辑器中愉快地测试对话系统了，无需搭建游戏界面！

**Happy Testing!** 🚀✨




