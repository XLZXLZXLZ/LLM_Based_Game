# NPC思考系统说明

## 📖 概述

思考系统为NPC提供了**内心独白**和**动态行为准则**的能力。NPC会定期进行"深度思考"，分析当前情况并制定接下来的行为策略。

## 🎯 设计理念

### 为什么需要思考系统？

传统的NPC对话系统通常只依赖固定的角色设定，缺乏对当前情境的动态适应。思考系统解决了以下问题：

1. **情境感知**: NPC能够分析当前对话的情境和氛围
2. **动态调整**: 根据玩家的行为调整自己的态度和策略
3. **内心世界**: 赋予NPC更真实的"内心活动"
4. **行为连贯性**: 通过行为准则保持多轮对话的一致性

### 工作原理

```
触发时机 → 构建思考提示词 → LLM思考 → 解析结果 → 整合到对话中
   ↓           ↓               ↓          ↓            ↓
首次对话    角色设定        生成两部分    内心想法     影响下N轮对话
每N次对话   当前情况        行为指导      行为准则
            对话历史
```

## 🏗️ 架构组成

### 核心类

#### 1. **NPCThought** (数据类)

存储单次思考的结果：
- `innerThought`: 内心想法（第一人称）
- `behaviorGuidance`: 行为指导（第三人称）
- `lifetime`: 有效期（持续多少次对话）
- `usageCount`: 已使用次数

#### 2. **ThoughtManager** (单例管理器)

负责思考流程的编排：
- 判断是否需要触发思考
- 调用LLM进行思考
- 解析和存储思考结果
- 管理思考的生命周期

#### 3. **ChatAgent 集成**

在对话流程中：
- 检查是否需要思考
- 执行思考流程（如果需要）
- 将思考结果整合到 SystemPrompt 和 UserMessage

## 🔧 配置项

### ChatAgent 配置

```csharp
[Header("思考系统设置")]
[SerializeField]
[Tooltip("是否启用思考系统")]
private bool enableThoughtSystem = true;
```

### ThoughtManager 配置

```csharp
[Header("思考配置")]
[SerializeField]
[Tooltip("思考间隔（每N次对话触发一次，0表示仅首次）")]
private int thoughtInterval = 5;

[SerializeField]
[Tooltip("思考结果有效期（持续多少次对话）")]
private int thoughtLifetime = 5;
```

**配置说明**：
- `thoughtInterval = 0`: 仅在首次对话时思考
- `thoughtInterval = 5`: 每5次对话触发一次思考
- `thoughtLifetime = 5`: 每次思考的结果持续5次对话

## 📋 使用指南

### 基本使用

思考系统默认启用，无需额外代码：

```csharp
// 正常发送消息，思考会自动触发
ChatAgent.Instance.SendMessage(
    npcProfile: myNPC,
    userMessage: "你好！",
    onSuccess: reply => Debug.Log(reply)
);
```

### 配置思考参数

```csharp
// 调整思考间隔（每3次对话思考一次）
ThoughtManager.Instance.ThoughtInterval = 3;

// 调整思考有效期（每次思考持续8次对话）
ThoughtManager.Instance.ThoughtLifetime = 8;

// 启用思考内容日志
ThoughtManager.Instance.LogThoughtContent = true;
```

### 禁用/启用思考系统

```csharp
// 禁用思考系统（适合简单对话或性能优化）
ChatAgent.Instance.EnableThoughtSystem = false;

// 重新启用
ChatAgent.Instance.EnableThoughtSystem = true;
```

### 清除思考数据

```csharp
// 清除特定NPC的思考数据
ChatAgent.Instance.ClearThought(npcProfile);

// 清除所有记忆和思考数据
ChatAgent.Instance.ClearAllMemory(npcProfile);

// 清除所有NPC的思考数据
ThoughtManager.Instance.ClearAllThoughts();
```

## 🔍 思考流程详解

### 触发条件

思考会在以下情况触发：

1. **首次对话**: NPC第一次与玩家交谈
2. **达到间隔**: 距离上次思考已经过了N次对话
3. **思考过期**: 上次思考的有效期已用完

### 思考内容

LLM会从角色视角进行深度思考，产生两部分内容：

#### 1. 内心想法（第一人称）

**问题导向**：
- 我对当前情况的真实感受和想法是什么？
- 我对玩家的态度和印象如何？
- 我有什么计划或顾虑？

**示例**：
```
这个人类看起来挺友善的，但我还不能完全信任他。
我需要试探一下他的真实意图，同时也不能暴露我的秘密。
如果他真的能帮我，也许我可以逐渐透露一些信息...
```

#### 2. 行为指导（第三人称）

**问题导向**：
- 接下来几轮对话中，我应该如何表现？
- 我的语气、态度应该如何调整？
- 有什么特别需要注意或避免的？

**示例**：
```
保持谨慎但不失礼貌的态度。
在回答问题时要留有余地，不要一次性说太多。
观察玩家的反应，如果他表现出善意，可以适度透露一些非关键信息。
避免谈论关于古代遗迹的具体位置。
```

### 整合机制

思考结果会被整合到对话中：

#### 整合到 SystemPrompt

```
【原始系统提示词】
你现在要扮演一个名叫"神秘商人"的角色...
【角色背景】...
【性格特征】...

↓ 整合思考结果 ↓

【原始系统提示词】
你现在要扮演一个名叫"神秘商人"的角色...
【角色背景】...
【性格特征】...

【当前行为指导】
保持谨慎但不失礼貌的态度...
（这是你近期思考后制定的行为准则，请在接下来的对话中遵循）
```

#### 整合到 UserMessage

```
【原始用户消息】
你知道古代遗迹的位置吗？

↓ 整合思考结果 ↓

【整合后的用户消息】
[我的内心想法: 这个人类看起来挺友善的，但我还不能完全信任他...]

你知道古代遗迹的位置吗？
```

**效果**：NPC在回答时会参考自己的内心想法，做出更符合当前心境的回应。

## 📊 思考生命周期

```
对话1: [触发思考] → 生成思考A → 应用思考A
对话2: 应用思考A (使用计数 1/5)
对话3: 应用思考A (使用计数 2/5)
对话4: 应用思考A (使用计数 3/5)
对话5: 应用思考A (使用计数 4/5)
对话6: [思考过期] → 生成思考B → 应用思考B
对话7: 应用思考B (使用计数 1/5)
...
```

## 🎨 高级用法

### 场景1: 重要剧情节点强制思考

```csharp
// 在关键剧情后，清除旧思考，强制NPC重新思考
ChatAgent.Instance.ClearThought(npcProfile);

// 下次对话会自动触发新思考
ChatAgent.Instance.SendMessage(npcProfile, "那件事之后，你还好吗？", ...);
```

### 场景2: 不同类型NPC的配置策略

```csharp
// 主线NPC: 频繁思考，保持新鲜感
ThoughtManager.Instance.ThoughtInterval = 3;
ThoughtManager.Instance.ThoughtLifetime = 3;

// 商人NPC: 较少思考，保持稳定
ThoughtManager.Instance.ThoughtInterval = 10;
ThoughtManager.Instance.ThoughtLifetime = 10;

// Boss战NPC: 仅首次思考
ThoughtManager.Instance.ThoughtInterval = 0;
ThoughtManager.Instance.ThoughtLifetime = 999;
```

### 场景3: 手动获取思考内容

```csharp
// 获取NPC当前的思考
var thought = ThoughtManager.Instance.GetThought(npcProfile.npcId);

if (thought != null)
{
    Debug.Log($"内心想法: {thought.innerThought}");
    Debug.Log($"行为指导: {thought.behaviorGuidance}");
    Debug.Log($"剩余有效次数: {thought.lifetime - thought.usageCount}");
}
```

## 🔧 调试技巧

### 查看思考内容

```csharp
// 启用思考内容日志
ThoughtManager.Instance.LogThoughtContent = true;

// 启用系统提示词日志（可以看到整合后的效果）
ChatAgent.Instance.LogSystemPrompt = true;
```

**控制台输出示例**：
```
[ThoughtManager] NPC(神秘商人)的思考:
【内心想法】
这个人类看起来挺友善的，但我还不能完全信任他...

【行为指导】
保持谨慎但不失礼貌的态度...

[ChatAgent] 系统提示词:
你现在要扮演一个名叫"神秘商人"的角色。
...
【当前行为指导】
保持谨慎但不失礼貌的态度...
```

## ⚠️ 注意事项

### 性能考虑

1. **额外的API调用**: 每次思考都会额外调用一次LLM API
   - 首次对话：2次调用（1次思考 + 1次对话）
   - 触发思考时：2次调用
   - 正常对话：1次调用

2. **优化建议**：
   - 调大 `thoughtInterval`，减少思考频率
   - 调大 `thoughtLifetime`，延长思考有效期
   - 对不重要的NPC禁用思考系统

### Token消耗

思考提示词会包含：
- 角色设定（完整的 SystemPrompt）
- 最近5条对话记录
- 当前用户消息
- 思考任务说明

**估算**: 每次思考约消耗 500-1000 tokens

### 最佳实践

1. **分层配置**: 为不同重要性的NPC配置不同的思考参数
2. **关键节点**: 在重要剧情节点手动清除思考，让NPC重新评估
3. **监控日志**: 定期查看思考内容，确保LLM输出符合预期
4. **测试调优**: 根据实际效果调整 `interval` 和 `lifetime`

## 🎯 效果对比

### 不使用思考系统

```
玩家: 你知道古代遗迹的位置吗？
NPC: 我知道一些传闻，但不确定是否准确。你为什么想知道？

玩家: 我想去探险。
NPC: 探险很危险，你确定要去吗？

玩家: 我很确定。
NPC: 好吧，遗迹在北方的山脉中。
```

**问题**: NPC的态度转变过于突然，缺乏合理的心理过程。

### 使用思考系统

```
[思考触发]
内心想法: 这个人类看起来挺友善的，但我还不能完全信任他...
行为指导: 保持谨慎但不失礼貌的态度，逐渐试探...

玩家: 你知道古代遗迹的位置吗？
NPC: (略显迟疑) 古代遗迹？这可是个敏感的话题... 你为什么对那里感兴趣？

玩家: 我想去探险。
NPC: (打量着你) 探险者... 我见过不少。大多数都有去无回。不过你看起来不像是鲁莽的人。

玩家: 我做好了准备。
NPC: (沉默片刻) ...好吧。我可以告诉你一些线索，但你要答应我一件事。

[5次对话后，思考更新]
内心想法: 这个人确实有诚意，而且看起来有能力。也许我可以信任他...
行为指导: 可以透露更多信息，但仍保留核心秘密...

玩家: 什么事？
NPC: (语气温和了许多) 如果你在遗迹中发现了红色的水晶，记得带一块给我。那是我的... 旧物。
```

**优势**: NPC展现出合理的心理变化过程，对话更加生动真实。

## 📚 相关文档

- [框架API文档.md](../框架API文档.md) - 完整的API参考
- [NPCMemory.cs](../Memory/NPCMemory.cs) - 记忆系统
- [ChatAgent.cs](../../ChatAgent.cs) - 对话代理

---

**版本**: v1.0  
**最后更新**: 2025-11-11




